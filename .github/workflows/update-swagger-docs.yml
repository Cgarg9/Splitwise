name: Update Swagger Documentation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Every day at 3 AM UTC
  push:
    branches:
      - main
    paths:
      - '**/*.go'
      - 'main.go'
      - 'internal/httpapi/handlers/**'
      - 'internal/httpapi/dto/**'

jobs:
  update-swagger:
    name: Generate and Update Swagger Docs
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install swag CLI
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Install dependencies
        run: go mod download

      - name: Generate Swagger docs
        run: |
          echo "ğŸ“š Generating Swagger documentation..."
          swag init -g main.go -o ./docs --parseDependency --parseInternal
          
          # Format the generated code
          swag fmt

      - name: Verify docs were generated
        run: |
          if [ ! -f "docs/swagger.json" ] || [ ! -f "docs/swagger.yaml" ]; then
            echo "âŒ Swagger docs were not generated properly!"
            exit 1
          fi
          echo "âœ… Swagger docs generated successfully"

      - name: Check for changes
        id: check_changes
        run: |
          git diff --exit-code docs/ && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT
          
          if [ "$(git diff --name-only docs/ | wc -l)" -gt 0 ]; then
            echo "ğŸ“ Files changed:"
            git diff --name-only docs/
          fi
          
      - name: Get current date
        id: date
        if: steps.check_changes.outputs.changed == 'true'
        run: echo "date=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: update Swagger documentation'
          committer: GitHub Actions <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: swagger-docs-${{ steps.date.outputs.date }}
          delete-branch: true
          title: 'ğŸ“š Update Swagger Documentation - ${{ steps.date.outputs.date }}'
          body: |
            ## ğŸ“š Swagger Documentation Update
            
            This PR updates the auto-generated Swagger/OpenAPI documentation.
            
            ### Changes
            - ğŸ”„ Regenerated Swagger docs from code annotations
            - ğŸ“ Updated API documentation files
            
            ### Files Changed
            ```
            docs/
            â”œâ”€â”€ docs.go
            â”œâ”€â”€ swagger.json
            â””â”€â”€ swagger.yaml
            ```
            
            ### How to Review
            1. Check that the changes match recent code updates
            2. Verify endpoints are correctly documented
            3. Test Swagger UI locally if needed
            
            ### Testing Locally
            ```bash
            go run main.go
            # Visit: http://localhost:8080/swagger/index.html
            ```
            
            ---
            **Triggered by:** ${{ github.event_name }}  
            **Run ID:** ${{ github.run_id }}  
            **Branch:** ${{ github.ref_name }}
            
            _Auto-generated by GitHub Actions_
          labels: |
            documentation
            automated
            swagger
          draft: false

      - name: Output PR URL
        if: steps.check_changes.outputs.changed == 'true' && steps.create_pr.outputs.pull-request-number
        run: |
          echo "âœ… Pull Request created!"
          echo "ğŸ”— PR URL: ${{ steps.create_pr.outputs.pull-request-url }}"
          echo "ğŸ“ PR Number: ${{ steps.create_pr.outputs.pull-request-number }}"

      - name: No changes detected
        if: steps.check_changes.outputs.changed != 'true'
        run: |
          echo "âœ… Swagger documentation is already up to date!"
          echo "â„¹ï¸  No changes detected - no PR needed."